name: Deploy to Firebase Hosting

# Force fresh deployment with latest code
on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - '.github/workflows/firebase-deploy.yml'
      - 'src/**'
      - 'package.json'
      - 'vite.config.ts'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: |
          rm -rf node_modules package-lock.json
          npm install --legacy-peer-deps
          npm install @rollup/rollup-linux-x64-gnu --save-optional --force || true

      - name: Build
        run: npm run build

      - name: Verify build output
        run: |
          if [ ! -d "dist" ] || [ ! -f "dist/index.html" ]; then
            echo "âŒ Build failed - dist/index.html missing"
            exit 1
          fi
          echo "âœ… Build verified: $(find dist -type f | wc -l) files"

      - name: Check for loop (prevent infinite retries)
        run: |
          node scripts/loop-breaker.mjs check firebase-deploy || {
            echo ""
            echo "ğŸ”´ LOOP BREAKER ACTIVATED!"
            echo ""
            echo "The deployment has failed multiple times in a row."
            echo "This indicates a persistent issue that needs manual intervention."
            echo ""
            echo "Common causes:"
            echo "  1. Expired or invalid FIREBASE_TOKEN"
            echo "  2. Invalid FIREBASE_SERVICE_ACCOUNT JSON"
            echo "  3. Missing Firebase project permissions"
            echo "  4. Firebase project configuration issue"
            echo ""
            echo "To fix:"
            echo "  1. Check the error logs above"
            echo "  2. Verify your Firebase credentials"
            echo "  3. Run: node scripts/loop-breaker.mjs reset firebase-deploy"
            echo "  4. Retry the deployment"
            exit 1
          }

      - name: Verify FIREBASE_TOKEN
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
        run: |
          echo "ğŸ” Verifying FIREBASE_TOKEN..."
          echo "Token check: ${FIREBASE_TOKEN:+SET}"
          echo "Token length: ${#FIREBASE_TOKEN}"
          
          # Check if token exists and has reasonable length
          if [ -z "${FIREBASE_TOKEN:-}" ] || [ ${#FIREBASE_TOKEN} -lt 10 ]; then
            echo "âŒ FIREBASE_TOKEN is not set or invalid in GitHub Secrets!"
            echo "Current length: ${#FIREBASE_TOKEN}"
            echo "Please verify FIREBASE_TOKEN is set in: Settings > Secrets and variables > Actions"
            exit 1
          fi
          
          echo "âœ… FIREBASE_TOKEN verified (length: ${#FIREBASE_TOKEN} characters)"

      - name: Install Firebase CLI
        run: npm install -g firebase-tools@latest

      - name: Run Firebase diagnostics
        run: |
          echo "ğŸ” Running Firebase diagnostics..."
          node scripts/diagnose-firebase.mjs || {
            echo ""
            echo "âš ï¸  Diagnostics found issues - check output above"
          }

      - name: Deploy to Firebase
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
        run: |
          echo "ğŸ” Deploying with FIREBASE_TOKEN"
          echo "ğŸ“‹ Token present: $([ -n "$FIREBASE_TOKEN" ] && echo "yes" || echo "no")"
          echo "ğŸ“‹ Project: newtifi-web"
          echo "ğŸ“‹ Checking firebase.json..."
          cat firebase.json || echo "firebase.json not found"
          echo ""
          echo "ğŸ“‹ Checking .firebaserc..."
          cat .firebaserc || echo ".firebaserc not found"
          echo ""
          echo "ğŸ“‹ Listing dist contents..."
          ls -la dist/ | head -10 || echo "dist/ not found"
          echo ""
          echo "ğŸš€ Starting deployment..."
          firebase deploy --only hosting --project newtifi-web --token "$FIREBASE_TOKEN" --non-interactive 2>&1 | tee /tmp/firebase-deploy.log || {
            echo ""
            echo "âŒ Deployment failed!"
            echo "ğŸ“‹ Last 50 lines of output:"
            tail -50 /tmp/firebase-deploy.log || echo "No log file"
            ERROR_MSG=$(tail -10 /tmp/firebase-deploy.log | tr '\n' ' ' || echo "Firebase deployment failed")
            node scripts/loop-breaker.mjs record firebase-deploy "$ERROR_MSG" || true
            exit 1
          }
          echo "âœ… Deployment complete"
          node scripts/loop-breaker.mjs reset firebase-deploy || true

