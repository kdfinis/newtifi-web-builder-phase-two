name: Deploy to Firebase Hosting

# NOTE: GitHub Pages is the primary deployment method for newtifi.com
# This workflow is for Firebase deployment (optional backup)
# To enable: Add FIREBASE_SERVICE_ACCOUNT secret to GitHub repository
on:
  workflow_dispatch: # Manual trigger only
  # push:
  #   branches: [ main ]
  # pull_request:
  #   branches: [ main ]

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4
      
    - name: üîç Check Firebase Service Account Secret
      id: check_secret
      run: |
        if [ -z "${{ secrets.FIREBASE_SERVICE_ACCOUNT }}" ]; then
          echo "‚ùå FIREBASE_SERVICE_ACCOUNT secret is missing!"
          echo ""
          echo "To fix this:"
          echo "1. Go to Firebase Console: https://console.firebase.google.com/"
          echo "2. Select project 'newtifi-web' ‚Üí Project Settings ‚Üí Service Accounts"
          echo "3. Click 'Generate new private key' and download the JSON file"
          echo "4. Go to GitHub ‚Üí Settings ‚Üí Secrets and variables ‚Üí Actions"
          echo "5. Add new secret: FIREBASE_SERVICE_ACCOUNT"
          echo "6. Paste the entire JSON content as the value"
          echo ""
          echo "See docs/FIREBASE_DEPLOYMENT_TROUBLESHOOTING.md for detailed instructions"
          exit 1
        else
          echo "‚úÖ FIREBASE_SERVICE_ACCOUNT secret found"
        fi
      
    - name: üì¶ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: üì¶ Install dependencies
      run: npm ci
      
    - name: üîß Install Firebase CLI and jq
      run: |
        npm install -g firebase-tools
        sudo apt-get update && sudo apt-get install -y jq
      
    - name: üî® Build project
      run: npm run build
      
    - name: üîê Setup Firebase Authentication
      env:
        FIREBASE_SERVICE_ACCOUNT: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
      run: |
        echo "$FIREBASE_SERVICE_ACCOUNT" > /tmp/firebase-service-account.json
        export GOOGLE_APPLICATION_CREDENTIALS=/tmp/firebase-service-account.json
        # Verify service account is valid JSON
        if ! jq empty /tmp/firebase-service-account.json 2>/dev/null; then
          echo "‚ùå FIREBASE_SERVICE_ACCOUNT is not valid JSON!"
          exit 1
        fi
        echo "‚úÖ Service account JSON is valid"
      
    - name: üî• Deploy to Firebase Hosting
      env:
        GOOGLE_APPLICATION_CREDENTIALS: /tmp/firebase-service-account.json
      run: |
        firebase deploy --only hosting --non-interactive --project newtifi-web
        
    - name: üßπ Cleanup
      if: always()
      run: |
        rm -f /tmp/firebase-service-account.json
