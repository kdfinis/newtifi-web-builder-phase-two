name: Deploy to Firebase Hosting

# NOTE: GitHub Pages is the primary deployment method for newtifi.com
# This workflow is for Firebase deployment (optional backup)
on:
  workflow_dispatch:    # manual trigger
  # push:
  #   branches:
  #     - main

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üîç Ensure auth secret exists
        run: |
          if [ -z "${{ secrets.FIREBASE_SERVICE_ACCOUNT }}" ] && [ -z "${{ secrets.FIREBASE_TOKEN }}" ]; then
            echo "‚ùå Repository secret FIREBASE_SERVICE_ACCOUNT or FIREBASE_TOKEN is required."
            echo ""
            echo "Option A (recommended when service account creation is allowed):"
            echo "  1) Create a Service Account JSON in Firebase Console ‚Üí Project Settings ‚Üí Service Accounts"
            echo "  2) Add it to GitHub Repo Secrets as FIREBASE_SERVICE_ACCOUNT"
            echo ""
            echo "Option B (works when service account key creation is blocked):"
            echo "  1) Run locally: firebase login:ci"
            echo "  2) Add the returned token to GitHub Repo Secrets as FIREBASE_TOKEN"
            exit 1
          fi

      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: üì¶ Install dependencies
        run: |
          # Remove existing node_modules and package-lock.json to fix Rollup optional deps issue
          rm -rf node_modules package-lock.json
          # Install dependencies fresh (this ensures optional dependencies are installed)
          npm install --legacy-peer-deps
          # Explicitly install Rollup's native module for Linux
          npm install @rollup/rollup-linux-x64-gnu --save-optional --force || npm install @rollup/rollup-linux-x64-gnu --save-optional
          # Verify Rollup module exists
          if [ ! -d "node_modules/@rollup/rollup-linux-x64-gnu" ]; then
            echo "‚ö†Ô∏è  Rollup native module not found, trying alternative installation..."
            npm install rollup --force
          fi

      - name: üî® Build
        run: npm run build

      - name: üî• Deploy to Firebase Hosting
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          # Use token authentication (preferred when service account key creation is blocked)
          firebaseToken: ${{ secrets.FIREBASE_TOKEN }}
          # Alternative: use service account if token is not available
          firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
          projectId: newtifi-web
