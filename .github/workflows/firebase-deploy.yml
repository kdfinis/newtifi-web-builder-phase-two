name: Deploy to Firebase Hosting

# NOTE: GitHub Pages is the primary deployment method for newtifi.com
# This workflow is for Firebase deployment (optional backup)
# To enable: Add FIREBASE_SERVICE_ACCOUNT secret to GitHub repository
on:
  workflow_dispatch: # Manual trigger only
  # push:
  #   branches: [ main ]
  # pull_request:
  #   branches: [ main ]

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4
      
    - name: üîç Check Firebase Authentication
      id: check_auth
      run: |
        if [ -z "${{ secrets.FIREBASE_SERVICE_ACCOUNT }}" ] && [ -z "${{ secrets.FIREBASE_TOKEN }}" ]; then
          echo "‚ùå Neither FIREBASE_SERVICE_ACCOUNT nor FIREBASE_TOKEN secret found!"
          echo ""
          echo "OPTION 1: Use Firebase Token (Recommended if key creation is blocked):"
          echo "1. Run locally: firebase login:ci"
          echo "2. Copy the generated token"
          echo "3. Add to GitHub Secrets as: FIREBASE_TOKEN"
          echo ""
          echo "OPTION 2: Use Service Account (if allowed):"
          echo "1. Go to Firebase Console: https://console.firebase.google.com/"
          echo "2. Select project 'newtifi-web' ‚Üí Project Settings ‚Üí Service Accounts"
          echo "3. Click 'Generate new private key' and download the JSON file"
          echo "4. Add to GitHub Secrets as: FIREBASE_SERVICE_ACCOUNT"
          echo ""
          exit 1
        elif [ -n "${{ secrets.FIREBASE_TOKEN }}" ]; then
          echo "‚úÖ FIREBASE_TOKEN secret found (using token authentication)"
        else
          echo "‚úÖ FIREBASE_SERVICE_ACCOUNT secret found (using service account)"
        fi
      
    - name: üì¶ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: üì¶ Install dependencies
      run: |
        # Remove existing node_modules and package-lock.json to fix Rollup optional deps issue
        rm -rf node_modules package-lock.json
        # Install dependencies fresh (this ensures optional dependencies are installed)
        npm install --legacy-peer-deps
        # Explicitly install Rollup's native module for Linux
        npm install @rollup/rollup-linux-x64-gnu --save-optional --force || npm install @rollup/rollup-linux-x64-gnu --save-optional
        # Verify Rollup module exists
        if [ ! -d "node_modules/@rollup/rollup-linux-x64-gnu" ]; then
          echo "‚ö†Ô∏è  Rollup native module not found, trying alternative installation..."
          npm install rollup --force
        fi
      
    - name: üîß Install Firebase CLI, gcloud CLI, and jq
      run: |
        npm install -g firebase-tools
        sudo apt-get update && sudo apt-get install -y jq curl gnupg
        # Install gcloud CLI as backup authentication method
        echo "deb [signed-by=/usr/share/keyrings/cloud.google.gpg] https://packages.cloud.google.com/apt cloud-sdk main" | sudo tee -a /etc/apt/sources.list.d/google-cloud-sdk.list
        curl https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo apt-key --keyring /usr/share/keyrings/cloud.google.gpg add -
        sudo apt-get update && sudo apt-get install -y google-cloud-sdk
        echo "‚úÖ All tools installed"
      
    - name: üî® Build project
      run: npm run build
      
    - name: üîê Setup Firebase Authentication
      env:
        FIREBASE_SERVICE_ACCOUNT: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
        FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
      run: |
        if [ -n "$FIREBASE_TOKEN" ]; then
          # Use Firebase token authentication
          echo "üîê Using Firebase token authentication..."
          echo "$FIREBASE_TOKEN" > /tmp/firebase-token.txt
          export FIREBASE_TOKEN="$FIREBASE_TOKEN"
          echo "‚úÖ Firebase token configured"
        elif [ -n "$FIREBASE_SERVICE_ACCOUNT" ]; then
          # Use service account authentication
          echo "üîê Using service account authentication..."
          echo "$FIREBASE_SERVICE_ACCOUNT" > /tmp/firebase-service-account.json
          
          # Verify service account is valid JSON
          if ! jq empty /tmp/firebase-service-account.json 2>/dev/null; then
            echo "‚ùå FIREBASE_SERVICE_ACCOUNT is not valid JSON!"
            exit 1
          fi
          
          # Extract service account email for verification
          SERVICE_ACCOUNT_EMAIL=$(jq -r '.client_email' /tmp/firebase-service-account.json)
          echo "‚úÖ Service account JSON is valid"
          echo "üìß Service account: $SERVICE_ACCOUNT_EMAIL"
          
          # Set environment variable for Firebase CLI
          export GOOGLE_APPLICATION_CREDENTIALS=/tmp/firebase-service-account.json
          
          # Verify credentials are accessible
          if [ ! -f "$GOOGLE_APPLICATION_CREDENTIALS" ]; then
            echo "‚ùå Service account file not found at $GOOGLE_APPLICATION_CREDENTIALS"
            exit 1
          fi
          
          echo "‚úÖ Service account credentials configured"
        else
          echo "‚ùå No authentication method configured!"
          exit 1
        fi
      
    - name: üîç Verify Firebase Project Access
      env:
        GOOGLE_APPLICATION_CREDENTIALS: ${{ secrets.FIREBASE_SERVICE_ACCOUNT && '/tmp/firebase-service-account.json' || '' }}
        FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
      run: |
        echo "üîç Verifying Firebase project access..."
        
        if [ -n "$FIREBASE_TOKEN" ]; then
          # Token authentication - just set project
          echo "üîê Using token authentication..."
          firebase use newtifi-web --non-interactive --token "$FIREBASE_TOKEN" || {
            echo "‚ùå Failed to set Firebase project with token"
            echo "üí° Verify token is valid and has access to project 'newtifi-web'"
            exit 1
          }
        else
          # Service account authentication
          echo "üîê Activating service account with gcloud..."
          gcloud auth activate-service-account --key-file=/tmp/firebase-service-account.json --quiet || {
            echo "‚ùå Failed to activate service account with gcloud"
            echo "üí° Check service account JSON is valid and has correct permissions"
            exit 1
          }
          
          # Set Firebase project
          firebase use newtifi-web --non-interactive || {
            echo "‚ùå Failed to set Firebase project"
            echo ""
            echo "üí° TROUBLESHOOTING:"
            echo "   1. Verify project ID 'newtifi-web' exists in Firebase Console"
            echo "   2. Check service account has 'Firebase Admin' IAM role"
            echo "   3. Verify 'firebase.googleapis.com' API is enabled"
            echo "   4. Check service account email: $(jq -r '.client_email' /tmp/firebase-service-account.json)"
            exit 1
          }
        fi
        
        echo "‚úÖ Project configured: newtifi-web"
      
    - name: üî• Deploy to Firebase Hosting
      env:
        GOOGLE_APPLICATION_CREDENTIALS: ${{ secrets.FIREBASE_SERVICE_ACCOUNT && '/tmp/firebase-service-account.json' || '' }}
        FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
        FIREBASE_PROJECT: newtifi-web
      run: |
        echo "üöÄ Starting Firebase Hosting deployment..."
        echo "üìÅ Build directory: dist/"
        
        # Verify dist directory exists and has content
        if [ ! -d "dist" ] || [ -z "$(ls -A dist)" ]; then
          echo "‚ùå dist/ directory is empty or missing!"
          exit 1
        fi
        
        # Deploy using Firebase CLI
        if [ -n "$FIREBASE_TOKEN" ]; then
          echo "üîê Deploying with token authentication..."
          firebase deploy --only hosting --non-interactive --project newtifi-web --token "$FIREBASE_TOKEN" || {
            echo "‚ùå Deployment failed!"
            exit 1
          }
        else
          echo "üîê Deploying with service account..."
          npm run deploy:firebase:admin || {
            echo "‚ùå Deployment failed!"
            exit 1
          }
        fi
        
        echo "‚úÖ Deployment completed successfully"
        
    - name: üßπ Cleanup
      if: always()
      run: |
        rm -f /tmp/firebase-service-account.json
