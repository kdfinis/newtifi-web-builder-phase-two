name: Deploy to Firebase Hosting

# NOTE: GitHub Pages is the primary deployment method for newtifi.com
# This workflow is for Firebase deployment (optional backup)
# To enable: Add FIREBASE_SERVICE_ACCOUNT secret to GitHub repository
on:
  workflow_dispatch: # Manual trigger only
  # push:
  #   branches: [ main ]
  # pull_request:
  #   branches: [ main ]

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4
      
    - name: üîç Check Firebase Authentication
      id: check_auth
      run: |
        if [ -z "${{ secrets.FIREBASE_SERVICE_ACCOUNT }}" ] && [ -z "${{ secrets.FIREBASE_TOKEN }}" ]; then
          echo "‚ùå Neither FIREBASE_SERVICE_ACCOUNT nor FIREBASE_TOKEN secret found!"
          echo ""
          echo "OPTION 1: Use Firebase Token (if service account key creation is blocked):"
          echo "1. Run locally: firebase login:ci"
          echo "2. Copy the generated token"
          echo "3. Add to GitHub Secrets as: FIREBASE_TOKEN"
          echo ""
          echo "OPTION 2: Use Service Account (if allowed):"
          echo "1. Go to Firebase Console ‚Üí Project Settings ‚Üí Service Accounts"
          echo "2. Generate new private key and download JSON"
          echo "3. Add to GitHub Secrets as: FIREBASE_SERVICE_ACCOUNT"
          exit 1
        elif [ -n "${{ secrets.FIREBASE_TOKEN }}" ]; then
          echo "‚úÖ FIREBASE_TOKEN secret found (using token authentication)"
        else
          echo "‚úÖ FIREBASE_SERVICE_ACCOUNT secret found (using service account)"
        fi
      
    - name: üì¶ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: üì¶ Install dependencies
      run: npm ci
      
    - name: üîß Install Firebase CLI, gcloud CLI, and jq
      run: |
        npm install -g firebase-tools
        sudo apt-get update && sudo apt-get install -y jq curl gnupg
        # Install gcloud CLI as backup authentication method
        echo "deb [signed-by=/usr/share/keyrings/cloud.google.gpg] https://packages.cloud.google.com/apt cloud-sdk main" | sudo tee -a /etc/apt/sources.list.d/google-cloud-sdk.list
        curl https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo apt-key --keyring /usr/share/keyrings/cloud.google.gpg add -
        sudo apt-get update && sudo apt-get install -y google-cloud-sdk
        echo "‚úÖ All tools installed"
      
    - name: üî® Build project
      run: npm run build
      
    - name: üîê Setup Firebase Authentication
      env:
        FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
        FIREBASE_SERVICE_ACCOUNT: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
      run: |
        # Use token if available (prioritize token over service account)
        if [ -n "$FIREBASE_TOKEN" ]; then
          echo "üîê Using Firebase token authentication..."
          export FIREBASE_TOKEN="$FIREBASE_TOKEN"
          echo "‚úÖ Firebase token configured"
          echo "TOKEN_MODE=true" >> $GITHUB_ENV
        elif [ -n "$FIREBASE_SERVICE_ACCOUNT" ]; then
          echo "üîê Using service account authentication..."
          echo "$FIREBASE_SERVICE_ACCOUNT" > /tmp/firebase-service-account.json
          
          if ! jq empty /tmp/firebase-service-account.json 2>/dev/null; then
            echo "‚ùå FIREBASE_SERVICE_ACCOUNT is not valid JSON!"
            exit 1
          fi
          
          SERVICE_ACCOUNT_EMAIL=$(jq -r '.client_email' /tmp/firebase-service-account.json)
          echo "‚úÖ Service account JSON is valid"
          echo "üìß Service account: $SERVICE_ACCOUNT_EMAIL"
          export GOOGLE_APPLICATION_CREDENTIALS=/tmp/firebase-service-account.json
          echo "TOKEN_MODE=false" >> $GITHUB_ENV
          
          if [ ! -f "$GOOGLE_APPLICATION_CREDENTIALS" ]; then
            echo "‚ùå Service account file not found"
            exit 1
          fi
          
          echo "‚úÖ Service account credentials configured"
        else
          echo "‚ùå No authentication method configured!"
          exit 1
        fi
      
    - name: üîç Verify Firebase Project Access
      env:
        FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
        GOOGLE_APPLICATION_CREDENTIALS: ${{ secrets.FIREBASE_SERVICE_ACCOUNT && '/tmp/firebase-service-account.json' || '' }}
      run: |
        echo "üîç Verifying Firebase project access..."
        
        if [ "$TOKEN_MODE" = "true" ] && [ -n "$FIREBASE_TOKEN" ]; then
          echo "üîê Using token authentication..."
          firebase use newtifi-web --non-interactive --token "$FIREBASE_TOKEN" || {
            echo "‚ùå Failed to set Firebase project with token"
            exit 1
          }
        else
          if ! firebase projects:list --non-interactive 2>/dev/null; then
            echo "‚ö†Ô∏è  Firebase CLI authentication failed, trying gcloud..."
            gcloud auth activate-service-account --key-file=/tmp/firebase-service-account.json --quiet
            export GOOGLE_APPLICATION_CREDENTIALS=/tmp/firebase-service-account.json
          fi
          
          firebase use newtifi-web --non-interactive || {
            echo "‚ùå Failed to set Firebase project"
            exit 1
          }
        fi
        
        echo "‚úÖ Project configured: newtifi-web"
      
    - name: üî• Deploy to Firebase Hosting
      env:
        FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
        GOOGLE_APPLICATION_CREDENTIALS: ${{ secrets.FIREBASE_SERVICE_ACCOUNT && '/tmp/firebase-service-account.json' || '' }}
        FIREBASE_PROJECT: newtifi-web
      run: |
        echo "üöÄ Starting Firebase Hosting deployment..."
        echo "üìÅ Build directory: dist/"
        
        if [ ! -d "dist" ] || [ -z "$(ls -A dist)" ]; then
          echo "‚ùå dist/ directory is empty or missing!"
          exit 1
        fi
        
        if [ "$TOKEN_MODE" = "true" ] && [ -n "$FIREBASE_TOKEN" ]; then
          echo "üîê Deploying with token authentication..."
          firebase deploy --only hosting --non-interactive --project newtifi-web --token "$FIREBASE_TOKEN" || {
            echo "‚ùå Deployment failed!"
            exit 1
          }
        else
          echo "üîê Deploying with service account..."
          firebase deploy --only hosting --non-interactive --project newtifi-web || {
            echo "‚ùå Deployment failed!"
            exit 1
          }
        fi
        
        echo "‚úÖ Deployment completed successfully"
        
    - name: üßπ Cleanup
      if: always()
      run: |
        rm -f /tmp/firebase-service-account.json
